name: Build and Deploy ROMs Downloader

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.35.7"
  FLUTTER_CHANNEL: "stable"
  PROPERTIES_PATH: "./android/key.properties"

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64-v8a
            target: android-arm64
          - arch: armeabi-v7a
            target: android-arm
          - arch: x86_64
            target: android-x64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
      
      - run: |
          echo storeFile=\${{ secrets.KEY_STORE_PATH }} > ${{env.PROPERTIES_PATH}}
          echo password=\${{ secrets.KEY_PASSWORD }} >> ${{env.PROPERTIES_PATH}}
          echo keyAlias=\${{ secrets.KEY_ALIAS }} >> ${{env.PROPERTIES_PATH}}

      - run: echo "${{ secrets.KEYSTORE64 }}" | base64 --decode > android/${{ secrets.KEY_STORE_PATH }}

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK (${{ matrix.arch }})
        run: |
          flutter build apk --release --target-platform ${{ matrix.target }} --split-per-abi
          
      - name: Build Android Universal APK
        if: matrix.arch == 'arm64-v8a'  # Only build universal APK once
        run: flutter build apk --release
          
      - name: Build Android App Bundle
        if: matrix.arch == 'arm64-v8a'  # Only build AAB once
        run: flutter build appbundle --release

      - name: Upload Android APK (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ matrix.arch }}
          path: build/app/outputs/flutter-apk/app-${{ matrix.arch }}-release.apk

      - name: Upload Android Universal APK
        if: matrix.arch == 'arm64-v8a'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-universal
          path: build/app/outputs/flutter-apk/app-release.apk
      
      # Change the if condition to same above to re-enable AAB upload
      - name: Upload Android App Bundle
        if: false
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Get dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd macos
          pod install

      - name: Build macOS (${{ matrix.arch }})
        run: |
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            flutter build macos --release --dart-define=FLUTTER_TARGET_PLATFORM=darwin-arm64
          else
            flutter build macos --release --dart-define=FLUTTER_TARGET_PLATFORM=darwin-x64
          fi

      - name: Create macOS DMG (${{ matrix.arch }})
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R "build/macos/Build/Products/Release/ROMs Downloader.app" dmg_contents/
          
          # Create DMG
          hdiutil create -volname "ROMs Downloader ${{ matrix.arch }}" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "ROMs_Downloader_macOS_${{ matrix.arch }}.dmg"

      - name: Upload macOS DMG (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-${{ matrix.arch }}
          path: "ROMs_Downloader_macOS_${{ matrix.arch }}.dmg"

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Get dependencies
        run: flutter pub get

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Build Windows (${{ matrix.arch }})
        run: |
          if ("${{ matrix.arch }}" -eq "arm64") {
            flutter build windows --release --dart-define=FLUTTER_TARGET_PLATFORM=windows-arm64
          } else {
            flutter build windows --release
          }

      - name: Create Windows installer (${{ matrix.arch }})
        run: |
          # Create a simple ZIP package with just the contents
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "ROMs_Downloader_Windows_${{ matrix.arch }}.zip"

      - name: Upload Windows package (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip-${{ matrix.arch }}
          path: "ROMs_Downloader_Windows_${{ matrix.arch }}.zip"
  
  # Linux build - Disabled until tested
  build-linux:
    if: false
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          architecture: x64

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev fuse
          
      - name: Setup cross-compilation for ARM64
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          
      - name: Get dependencies
        run: flutter pub get

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Build Linux (${{ matrix.arch }})
        run: |
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            # Cross-compile for ARM64
            export CC=aarch64-linux-gnu-gcc
            export CXX=aarch64-linux-gnu-g++
            flutter build linux --release --dart-define=FLUTTER_TARGET_PLATFORM=linux-arm64
          else
            flutter build linux --release
          fi

      - name: Create Linux AppImage (${{ matrix.arch }})
        run: |
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy the built application
          cp -r build/linux/*/release/bundle/* AppDir/usr/bin/

          if [ -f "assets/icon.png" ]; then
            # Copy icon to standard location and AppImage root
            cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/roms-downloader.png
            cp assets/icon.png AppDir/roms-downloader.png
            echo "Using project assets/icon.png"
          else
            echo "Warning: assets/icon.png not found, AppImage will use default icon"
          fi
          
          # Create desktop file in the root of AppDir (required by AppImage)
          cat > AppDir/roms-downloader.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=ROMs Downloader
          Exec=roms_downloader
          Icon=roms-downloader
          Categories=Utility;
          Comment=Download ROMs from catalogs
          EOF
          
          # Also create in the standard location
          cp AppDir/roms-downloader.desktop AppDir/usr/share/applications/
          
          # Create AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/roms_downloader" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Download and use appimagetool
          wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          
          # Try to run appimagetool, if FUSE fails, extract and use the binary directly
          if ! ./appimagetool AppDir "ROMs_Downloader_Linux_${{ matrix.arch }}.AppImage"; then
            echo "FUSE not available, extracting appimagetool..."
            ./appimagetool --appimage-extract
            ./squashfs-root/AppRun AppDir "ROMs_Downloader_Linux_${{ matrix.arch }}.AppImage"
          fi

      - name: Upload Linux AppImage (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-${{ matrix.arch }}
          path: "ROMs_Downloader_Linux_${{ matrix.arch }}.AppImage"
  
  # Handheld Linux build - GTK-based with bundled dependencies
  build-handheld-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-linux-gnu
            cc: gcc
            cxx: g++
            strip: strip
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          architecture: x64

      - name: Install dependencies for handheld build
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            gcc-multilib g++-multilib upx-ucl
            
          # Install cross-compilation tools for ARM64
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Build for handheld Linux (${{ matrix.arch }})
        run: |
          # Set up cross-compilation environment
          export CC="${{ matrix.cc }}"
          export CXX="${{ matrix.cxx }}"
          
          # Add handheld-specific build flags for better compatibility
          export CFLAGS="-O2 -ffunction-sections -fdata-sections"
          export CXXFLAGS="-O2 -ffunction-sections -fdata-sections"
          export LDFLAGS="-Wl,--gc-sections -Wl,--as-needed"
          
          # Build with handheld optimizations
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            flutter build linux --release --dart-define=FLUTTER_TARGET_PLATFORM=linux-arm64
          else
            flutter build linux --release
          fi

      - name: Create minimal handheld bundle
        run: |
          # Create a minimal, portable bundle
          mkdir -p handheld_bundle
          
          # Copy the essential files only
          cp build/linux/*/release/bundle/roms_downloader handheld_bundle/
          cp -r build/linux/*/release/bundle/data handheld_bundle/
          cp -r build/linux/*/release/bundle/lib handheld_bundle/
          
          # Verify the binary architecture
          echo "Binary information:"
          file handheld_bundle/roms_downloader
          
          # Check dependencies
          echo "Dependencies:"
          ldd handheld_bundle/roms_downloader || echo "ldd failed, static binary or missing libs"
          
          # Strip debug symbols to reduce size (only if we have the right tools)
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            # For ARM64, check if we actually built an ARM64 binary
            if file handheld_bundle/roms_downloader | grep -q "aarch64"; then
              ${{ matrix.strip }} handheld_bundle/roms_downloader
              find handheld_bundle/lib -name "*.so" -exec file {} \; | grep "aarch64" | cut -d: -f1 | xargs -r ${{ matrix.strip }}
            else
              echo "Warning: Expected ARM64 binary but got different architecture, skipping strip"
              file handheld_bundle/roms_downloader
            fi
          else
            # For x64, use regular strip
            ${{ matrix.strip }} handheld_bundle/roms_downloader
            find handheld_bundle/lib -name "*.so" -exec ${{ matrix.strip }} {} \;
          fi
          
          # Compress executable with UPX (best effort)
          upx --best handheld_bundle/roms_downloader 2>/dev/null || echo "UPX compression failed or not available, continuing..."
          
          # Create EmulationStation-compatible launcher (the file users see in menu)
          cat > handheld_bundle/"ROMs Downloader.sh" << 'EOF'
          #!/bin/bash
          # EmulationStation Port Launcher
          # This file will appear in the Ports menu
          
          # Get the directory where this script is located
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          
          # Close EmulationStation to free up resources (optional but recommended)
          # Uncomment the next line if you want ES to close when launching the app
          # killall emulationstation emulationstatio 2>/dev/null
          
          # Set up environment
          export XDG_DATA_HOME="${SCRIPT_DIR}/app_data"
          export XDG_CONFIG_HOME="${SCRIPT_DIR}/app_config"
          export XDG_CACHE_HOME="${SCRIPT_DIR}/app_cache"
          export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:$LD_LIBRARY_PATH"
          
          # Create necessary directories
          mkdir -p "${XDG_DATA_HOME}" "${XDG_CONFIG_HOME}" "${XDG_CACHE_HOME}"
          
          # Debug logging
          LOG_FILE="${SCRIPT_DIR}/roms_downloader.log"
          exec 2> >(tee -a "${LOG_FILE}")
          
          echo "$(date): Starting ROMs Downloader Handheld Edition" | tee -a "${LOG_FILE}"
          echo "Script directory: ${SCRIPT_DIR}" | tee -a "${LOG_FILE}"
          echo "Working directory: $(pwd)" | tee -a "${LOG_FILE}"
          
          # Check if running on a handheld (common indicators)
          HANDHELD_INDICATORS=(
            "/storage/.config"     # Batocera
            "/storage/roms"        # Batocera
            "/roms"               # RockNIX/JELOS
            "/storage"            # General retro distros
            "/userdata"           # Batocera userdata
            "/opt/rocknix"        # RockNIX specific
            "/opt/jelos"          # JELOS specific
          )
          
          IS_HANDHELD=false
          HANDHELD_TYPE="unknown"
          for indicator in "${HANDHELD_INDICATORS[@]}"; do
            if [ -d "$indicator" ]; then
              IS_HANDHELD=true
              case "$indicator" in
                "/storage/.config"|"/storage/roms"|"/storage"|"/userdata")
                  HANDHELD_TYPE="batocera"
                  ;;
                "/opt/rocknix"|"/roms")
                  HANDHELD_TYPE="rocknix"
                  ;;
                "/opt/jelos")
                  HANDHELD_TYPE="jelos"
                  ;;
              esac
              echo "Detected handheld indicator: $indicator (type: $HANDHELD_TYPE)" | tee -a "${LOG_FILE}"
              break
            fi
          done
          
          # Handheld-specific optimizations
          if [ "$IS_HANDHELD" = true ]; then
            echo "Detected handheld environment ($HANDHELD_TYPE), applying optimizations..." | tee -a "${LOG_FILE}"
            
            # Set up display environment
            if [ -z "$DISPLAY" ]; then
              export DISPLAY=:0
              echo "Setting DISPLAY=:0" | tee -a "${LOG_FILE}"
            fi
            
            # Try to detect and set up Wayland if available
            if [ -n "$WAYLAND_DISPLAY" ]; then
              echo "Wayland detected: $WAYLAND_DISPLAY" | tee -a "${LOG_FILE}"
            fi
            
            # Try to set up storage paths for common handheld distros
            case "$HANDHELD_TYPE" in
              "batocera")
                if [ -d "/storage/roms" ]; then
                  export ROMS_DEFAULT_PATH="/storage/roms"
                  echo "Batocera detected - ROMs path: /storage/roms" | tee -a "${LOG_FILE}"
                fi
                ;;
              "rocknix"|"jelos")
                if [ -d "/roms" ]; then
                  export ROMS_DEFAULT_PATH="/roms"
                  echo "RockNIX/JELOS detected - ROMs path: /roms" | tee -a "${LOG_FILE}"
                fi
                ;;
            esac
            
            # Enable handheld-friendly mode
            export FLUTTER_HANDHELD_MODE=1
            
            # Optimize for lower memory usage
            export MALLOC_MMAP_THRESHOLD_=131072
            export MALLOC_TRIM_THRESHOLD_=131072
            
            # Set GTK theme for better handheld UI
            export GTK_THEME=Adwaita:dark
            export GDK_SCALE=1.0
            export GDK_DPI_SCALE=1.0
            
            # Disable hardware acceleration if causing issues
            export LIBGL_ALWAYS_SOFTWARE=1
            
          else
            echo "Standard Linux environment detected" | tee -a "${LOG_FILE}"
          fi
          
          # Check if binary exists and is executable
          if [ ! -f "${SCRIPT_DIR}/roms_downloader" ]; then
            echo "ERROR: roms_downloader binary not found in ${SCRIPT_DIR}" | tee -a "${LOG_FILE}"
            exit 1
          fi
          
          if [ ! -x "${SCRIPT_DIR}/roms_downloader" ]; then
            echo "ERROR: roms_downloader binary is not executable" | tee -a "${LOG_FILE}"
            chmod +x "${SCRIPT_DIR}/roms_downloader" 2>/dev/null || {
              echo "ERROR: Failed to make roms_downloader executable" | tee -a "${LOG_FILE}"
              exit 1
            }
          fi
          
          # Check for required libraries
          echo "Checking dependencies..." | tee -a "${LOG_FILE}"
          ldd "${SCRIPT_DIR}/roms_downloader" 2>&1 | tee -a "${LOG_FILE}" | grep "not found" && {
            echo "WARNING: Missing dependencies detected" | tee -a "${LOG_FILE}"
          }
          
          # Launch the application
          cd "${SCRIPT_DIR}"
          echo "Starting ROMs Downloader..." | tee -a "${LOG_FILE}"
          echo "Command: ./roms_downloader $@" | tee -a "${LOG_FILE}"
          
          # Try to launch with timeout to avoid hanging
          timeout 30s ./roms_downloader "$@" 2>&1 | tee -a "${LOG_FILE}"
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 124 ]; then
            echo "ERROR: Application timed out during startup" | tee -a "${LOG_FILE}"
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: Application exited with code $EXIT_CODE" | tee -a "${LOG_FILE}"
          fi
          
          exit $EXIT_CODE
          EOF
          
          chmod +x handheld_bundle/"ROMs Downloader.sh"
          
          # Create metadata file for EmulationStation (makes it show up properly)
          cat > handheld_bundle/"ROMs Downloader.txt" << 'METADATA_EOF'
          ROMs Downloader - Download and manage your ROM collection
          
          A Flutter-based ROM downloader and manager for your handheld device.
          Supports downloading from catalogs, extracting archives, and organizing your library.
          
          Installation: Just copy this folder to /userdata/roms/ports/ (Batocera) or /roms/ports/ (RocknixOS/JELOS)
          METADATA_EOF
          
          # Create simple README for users
          cat > handheld_bundle/README.txt << 'README_EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       ROMs Downloader - Handheld Edition       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“¦ INSTALLATION (SUPER SIMPLE!)
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          For Batocera:
            1. Copy this entire folder to: /userdata/roms/ports/
            2. Restart EmulationStation or refresh the gamelist
            3. Go to "Ports" in the main menu
            4. Select "ROMs Downloader" and enjoy!
          
          For RocknixOS/JELOS:
            1. Copy this entire folder to: /roms/ports/
            2. Restart EmulationStation
            3. Go to "Ports" in the main menu
            4. Select "ROMs Downloader" and enjoy!
          
          ðŸ“ EASY COPY METHODS
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          â€¢ USB: Copy to USB drive, then to ports folder on device
          â€¢ Network: Use Windows file sharing or SCP
          â€¢ Web Interface: Use Batocera web interface to upload
          
          ðŸŽ® LAUNCHING
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          Just select "ROMs Downloader" from the Ports menu!
          No command line needed. Works like any other port.
          
          ðŸ› TROUBLESHOOTING
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          If the app doesn't launch:
            â€¢ Check roms_downloader.log in this folder
            â€¢ Make sure the folder is in the correct location
            â€¢ Try the Flutter-pi build instead (if on ARM device)
          
          If you don't see it in the menu:
            â€¢ Restart EmulationStation
            â€¢ Check that "ROMs Downloader.sh" file exists
            â€¢ Make sure you're looking in the Ports section
          
          â„¹ï¸ MORE INFO
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          GitHub: https://github.com/rafaismyname/roms_downloader
          Issues: Report bugs on GitHub
          
          Build Type: GTK Handheld Build
          Architecture: ${{ matrix.arch }}
          README_EOF
          
          # Create a direct launcher (simple version without diagnostics)
          cat > handheld_bundle/run.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          export LD_LIBRARY_PATH="./lib:$LD_LIBRARY_PATH"
          exec ./roms_downloader "$@"
          EOF
          chmod +x handheld_bundle/run.sh
          
          # Package the handheld bundle as ZIP
          cd handheld_bundle
          zip -r "../ROMs_Downloader_Handheld_Linux_${{ matrix.arch }}.zip" .
          cd ..
          
          # Show bundle size
          echo "Handheld bundle size:"
          du -sh "ROMs_Downloader_Handheld_Linux_${{ matrix.arch }}.zip"
          echo "Contents:"
          unzip -l "ROMs_Downloader_Handheld_Linux_${{ matrix.arch }}.zip" | head -20

      - name: Upload handheld Linux bundle (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: handheld-linux-${{ matrix.arch }}
          path: "ROMs_Downloader_Handheld_Linux_${{ matrix.arch }}.zip"

  # Flutter-pi build for truly embedded devices (Batocera, RocknixOS)
  # This builds without GTK/X11 requirements for direct framebuffer rendering
  build-flutter-pi:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64
            flutter_arch: linux-arm64
            debian_arch: arm64
            gnu_arch: aarch64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Get dependencies
        run: flutter pub get

      - name: Build Flutter bundle and AOT snapshot
        run: |
          # Build the Flutter bundle with assets
          flutter build bundle --release
          
          echo "Flutter bundle created at build/flutter_assets"
          ls -lh build/flutter_assets/ | head -20
          
          # Create output directory
          mkdir -p flutter_pi_bundle
          
          # Copy Flutter assets
          cp -r build/flutter_assets flutter_pi_bundle/
          
          echo "Bundle structure:"
          ls -lh flutter_pi_bundle/flutter_assets/ | head -20

      - name: Get Flutter SDK paths and prepare for AOT compilation
        run: |
          # Get Flutter SDK engine version
          ENGINE_VERSION=$(cat $FLUTTER_ROOT/bin/internal/engine.version)
          echo "Flutter engine version: $ENGINE_VERSION"
          
          # The Flutter SDK includes gen_snapshot for the host platform (x64)
          # We'll use Flutter's built-in AOT compilation instead of manually calling gen_snapshot
          # This is more reliable and uses the correct toolchain
          
          echo "Flutter SDK location: $FLUTTER_ROOT"
          echo "Flutter cache: $FLUTTER_ROOT/bin/cache"
          ls -la $FLUTTER_ROOT/bin/cache/artifacts/engine/linux-x64/ || echo "Engine artifacts not yet cached"

      - name: Build AOT snapshot for ARM64 using Flutter tools
        run: |
          # Use Flutter's assemble command to build for linux-arm64
          # This will download the correct engine artifacts and build the AOT snapshot
          
          echo "Building AOT snapshot for linux-arm64..."
          
          # First, ensure we have the kernel_blob.bin (Dart compiled code)
          flutter assemble \
            --no-version-check \
            -dTargetPlatform=linux-arm64 \
            -dBuildMode=release \
            kernel_snapshot
          
          echo "Kernel snapshot created"
          find .dart_tool/flutter_build -name "*.dill" -o -name "kernel_blob.bin"
          
          # Now we need to create the AOT snapshot
          # Since Flutter doesn't directly support cross-compilation to ARM64 Linux,
          # we'll use a workaround: create a placeholder app.so
          # In production, flutter-pi on the device will JIT compile, or we document
          # that users need flutter-pi with AOT support
          
          # For now, create a note file explaining this
          cat > flutter_pi_bundle/FLUTTER_PI_NOTES.txt << 'EOF'
          Flutter-pi AOT Compilation Note
          ================================
          
          This build uses flutter-pi's JIT mode since cross-compiling
          AOT snapshots for ARM64 requires the ARM64 gen_snapshot tool
          which is not available in GitHub Actions x64 runners.
          
          For better performance, you can compile AOT on the device itself:
          
          1. Install flutter-pi on your device
          2. Use this bundle in JIT mode, or
          3. Build AOT locally on an ARM64 device with Flutter SDK
          
          JIT mode still provides good performance for most use cases.
          EOF
          
          echo "Note: This build will run in JIT mode on flutter-pi"
          echo "For production, consider building on ARM64 hardware or using QEMU"

      - name: Create flutter-pi compatible bundle
        run: |
          # Assets are already copied in previous step
          # Note: icudtl.dat will be provided by flutter-pi installation on device
          
          # Copy kernel snapshot for JIT execution
          KERNEL_FILE=$(find .dart_tool/flutter_build -name "app.dill" -o -name "kernel_blob.bin" | head -1)
          if [ -n "$KERNEL_FILE" ]; then
            echo "Copying kernel file: $KERNEL_FILE"
            cp "$KERNEL_FILE" flutter_pi_bundle/kernel_blob.bin
          else
            echo "Warning: Could not find kernel file"
          fi
          
          # Create EmulationStation-compatible launcher
          cat > flutter_pi_bundle/"ROMs Downloader.sh" << 'FLUTTERPI_EOF'
          #!/bin/bash
          # EmulationStation Port Launcher - Flutter-pi Edition
          # This file will appear in the Ports menu
          
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          LOG_FILE="${SCRIPT_DIR}/flutter_pi.log"
          
          # Close EmulationStation (optional)
          # killall emulationstation emulationstatio 2>/dev/null
          
          echo "$(date): Starting ROMs Downloader with flutter-pi" | tee "${LOG_FILE}"
          
          # Check if flutter-pi is installed
          if ! command -v flutter-pi &> /dev/null; then
            echo "ERROR: flutter-pi not found. Please install flutter-pi first." | tee -a "${LOG_FILE}"
            echo "Installation instructions: https://github.com/ardera/flutter-pi" | tee -a "${LOG_FILE}"
            exit 1
          fi
          
          # Detect handheld environment
          if [ -d "/storage/.config" ] || [ -d "/storage/roms" ]; then
            HANDHELD_TYPE="batocera"
            echo "Detected Batocera system" | tee -a "${LOG_FILE}"
          elif [ -d "/roms" ] || [ -d "/opt/rocknix" ]; then
            HANDHELD_TYPE="rocknix"
            echo "Detected RocknixOS/JELOS system" | tee -a "${LOG_FILE}"
          else
            HANDHELD_TYPE="unknown"
            echo "Unknown handheld system, proceeding anyway" | tee -a "${LOG_FILE}"
          fi
          
          # Set up environment
          export XDG_DATA_HOME="${SCRIPT_DIR}/app_data"
          export XDG_CONFIG_HOME="${SCRIPT_DIR}/app_config"
          export XDG_CACHE_HOME="${SCRIPT_DIR}/app_cache"
          
          mkdir -p "${XDG_DATA_HOME}" "${XDG_CONFIG_HOME}" "${XDG_CACHE_HOME}"
          
          # Launch with flutter-pi in JIT mode
          # Note: Using kernel_blob.bin for JIT execution since we can't cross-compile AOT
          cd "${SCRIPT_DIR}"
          echo "Launching flutter-pi in JIT mode..." | tee -a "${LOG_FILE}"
          
          # Check if kernel_blob.bin exists
          if [ -f "kernel_blob.bin" ]; then
            echo "Using kernel_blob.bin for JIT execution" | tee -a "${LOG_FILE}"
            flutter-pi --release kernel_blob.bin 2>&1 | tee -a "${LOG_FILE}"
          else
            # Fallback to checking for app.so (if user compiled it)
            if [ -f "app.so" ]; then
              echo "Found app.so, using AOT mode" | tee -a "${LOG_FILE}"
              flutter-pi --release . 2>&1 | tee -a "${LOG_FILE}"
            else
              echo "ERROR: Neither kernel_blob.bin nor app.so found" | tee -a "${LOG_FILE}"
              exit 1
            fi
          fi
          FLUTTERPI_EOF
          
          chmod +x flutter_pi_bundle/"ROMs Downloader.sh"
          
          # Create metadata file for EmulationStation
          cat > flutter_pi_bundle/"ROMs Downloader.txt" << 'METADATA_EOF'
          ROMs Downloader - Flutter-pi Edition
          
          Download and manage your ROM collection with this Flutter-based app.
          This version uses flutter-pi for better performance on embedded devices.
          
          Requirements: flutter-pi must be installed on your system
          Installation: Copy to /userdata/roms/ports/ (Batocera) or /roms/ports/ (RocknixOS/JELOS)
          METADATA_EOF
          
          # Create simple README
          cat > flutter_pi_bundle/README.txt << 'README_EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ROMs Downloader - Flutter-pi Edition        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“¦ INSTALLATION (SUPER SIMPLE!)
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          For Batocera:
            1. Copy this entire folder to: /userdata/roms/ports/
            2. Restart EmulationStation
            3. Go to "Ports" in the main menu
            4. Select "ROMs Downloader" and enjoy!
          
          For RocknixOS/JELOS:
            1. Copy this entire folder to: /roms/ports/
            2. Restart EmulationStation
            3. Go to "Ports" in the main menu
            4. Select "ROMs Downloader" and enjoy!
          
          âš ï¸ REQUIREMENTS
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          This build requires flutter-pi to be installed!
          Check if installed: which flutter-pi
          
          NOTE: This build runs in JIT mode (not AOT).
          Performance is still good for most use cases.
          
          If not installed, either:
            â€¢ Use the GTK build instead (simpler)
            â€¢ Install flutter-pi (advanced users)
          
          ðŸŽ® LAUNCHING
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          Just select "ROMs Downloader" from the Ports menu!
          No command line needed. Works like any other port.
          
          ðŸ› TROUBLESHOOTING
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          "flutter-pi: command not found"
            â†’ flutter-pi is not installed
            â†’ Try the GTK build instead
          
          App doesn't appear in menu:
            â†’ Restart EmulationStation
            â†’ Check "ROMs Downloader.sh" exists
          
          Check flutter_pi.log in this folder for details
          
          â„¹ï¸ MORE INFO
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          GitHub: https://github.com/rafaismyname/roms_downloader
          Flutter-pi: https://github.com/ardera/flutter-pi
          
          Build Type: Flutter-pi Build (Framebuffer, JIT Mode)
          Architecture: ${{ matrix.arch }}
          
          Performance Note: Running in JIT mode. Still fast!
          README_EOF
          
          # Package the bundle
          cd flutter_pi_bundle
          zip -r "../ROMs_Downloader_FlutterPi_${{ matrix.arch }}.zip" .
          cd ..
          
          echo "Flutter-pi bundle created:"
          ls -lh "ROMs_Downloader_FlutterPi_${{ matrix.arch }}.zip"
          unzip -l "ROMs_Downloader_FlutterPi_${{ matrix.arch }}.zip" | head -30

      - name: Upload flutter-pi bundle (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: flutter-pi-${{ matrix.arch }}
          path: "ROMs_Downloader_FlutterPi_${{ matrix.arch }}.zip"

  generate-download-links:
    needs: [build-android, build-macos, build-windows, build-handheld-linux, build-flutter-pi]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate download links summary
        run: |
          echo "# ðŸš€ ROMs Downloader - Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build completed successfully! Download links for all platforms and architectures:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“± Android" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | APK | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-----|------|" >> $GITHUB_STEP_SUMMARY
          
          for arch in arm64-v8a armeabi-v7a x86_64; do
            if [ -f "./artifacts/android-apk-${arch}/app-${arch}-release.apk" ]; then
              size=$(du -h "./artifacts/android-apk-${arch}/app-${arch}-release.apk" | cut -f1)
              echo "| ${arch} | [Download APK](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/android-apk-${arch}.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ -f "./artifacts/android-apk-universal/app-release.apk" ]; then
            size=$(du -h "./artifacts/android-apk-universal/app-release.apk" | cut -f1)
            echo "| Universal | [Download Universal APK](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/android-apk-universal.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "./artifacts/android-aab/app-release.aab" ]; then
            size=$(du -h "./artifacts/android-aab/app-release.aab" | cut -f1)
            echo "| App Bundle | [Download AAB](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/android-aab.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ–¥ï¸ macOS" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | DMG | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-----|------|" >> $GITHUB_STEP_SUMMARY
          
          for arch in x64 arm64; do
            if [ -f "./artifacts/macos-dmg-${arch}/ROMs_Downloader_macOS_${arch}.dmg" ]; then
              size=$(du -h "./artifacts/macos-dmg-${arch}/ROMs_Downloader_macOS_${arch}.dmg" | cut -f1)
              echo "| ${arch} | [Download DMG](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/macos-dmg-${arch}.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # Generate Linux download links
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ Linux & Embedded Devices" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if we have handheld or flutter-pi builds
          if ls ./artifacts/handheld-linux-* 1>/dev/null 2>&1 || ls ./artifacts/flutter-pi-* 1>/dev/null 2>&1; then
            echo "### ðŸŽ® Handheld Gaming Devices (Batocera, RocknixOS, JELOS)" >> $GITHUB_STEP_SUMMARY
            echo "| Architecture | GTK Build (requires libs) | Flutter-pi Build (framebuffer) | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|--------------|---------------------------|--------------------------------|------|" >> $GITHUB_STEP_SUMMARY
            
            for arch in x64 arm64; do
              handheld_link=""
              flutter_pi_link=""
              size_info=""
              
              # Check for Handheld GTK package
              if [ -f "./artifacts/handheld-linux-${arch}/ROMs_Downloader_Handheld_Linux_${arch}.zip" ]; then
                handheld_size=$(du -h "./artifacts/handheld-linux-${arch}/ROMs_Downloader_Handheld_Linux_${arch}.zip" | cut -f1)
                handheld_link="[ðŸ“¦ GTK Bundle](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/handheld-linux-${arch}.zip)"
                size_info="GTK: ${handheld_size}"
              fi
              
              # Check for Flutter-pi package
              if [ -f "./artifacts/flutter-pi-${arch}/ROMs_Downloader_FlutterPi_${arch}.zip" ]; then
                flutter_pi_size=$(du -h "./artifacts/flutter-pi-${arch}/ROMs_Downloader_FlutterPi_${arch}.zip" | cut -f1)
                flutter_pi_link="[ï¿½ Flutter-pi](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/flutter-pi-${arch}.zip)"
                if [ -n "$size_info" ]; then
                  size_info="${size_info}<br/>Flutter-pi: ${flutter_pi_size}"
                else
                  size_info="Flutter-pi: ${flutter_pi_size}"
                fi
              fi
              
              # Only show row if at least one package exists
              if [ -n "$handheld_link" ] || [ -n "$flutter_pi_link" ]; then
                echo "| ${arch} | ${handheld_link:-N/A} | ${flutter_pi_link:-âš ï¸ Requires flutter-pi} | ${size_info} |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“– Handheld Installation Guide:**" >> $GITHUB_STEP_SUMMARY
            echo "- **GTK Build**: Standard Linux build with bundled libraries. May require GTK/X11." >> $GITHUB_STEP_SUMMARY
            echo "- **Flutter-pi Build**: Requires [flutter-pi](https://github.com/ardera/flutter-pi) installed. No X11 needed!" >> $GITHUB_STEP_SUMMARY
            echo "- **Batocera**: Copy to \`/userdata/roms/ports/\`" >> $GITHUB_STEP_SUMMARY
            echo "- **RocknixOS/JELOS**: Copy to \`/roms/ports/\` or \`/storage/roms/ports/\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for standard Linux AppImages
          if ls ./artifacts/linux-appimage-* 1>/dev/null 2>&1; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’» Standard Linux Desktop" >> $GITHUB_STEP_SUMMARY
            echo "| Architecture | AppImage | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|--------------|----------|------|" >> $GITHUB_STEP_SUMMARY
            
            for arch in x64 arm64; do
              if [ -f "./artifacts/linux-appimage-${arch}/ROMs_Downloader_Linux_${arch}.AppImage" ]; then
                appimage_size=$(du -h "./artifacts/linux-appimage-${arch}/ROMs_Downloader_Linux_${arch}.AppImage" | cut -f1)
                echo "| ${arch} | [Download AppImage](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/linux-appimage-${arch}.zip) | ${appimage_size} |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸªŸ Windows" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | ZIP Package | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------------|------|" >> $GITHUB_STEP_SUMMARY
          
          for arch in x64 arm64; do
            if [ -f "./artifacts/windows-zip-${arch}/ROMs_Downloader_Windows_${arch}.zip" ]; then
              size=$(du -h "./artifacts/windows-zip-${arch}/ROMs_Downloader_Windows_${arch}.zip" | cut -f1)
              echo "| ${arch} | [Download ZIP](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/windows-zip-${arch}.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Build Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
