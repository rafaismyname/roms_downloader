name: Build and Deploy ROMs Downloader

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.35.7"
  FLUTTER_CHANNEL: "stable"
  PROPERTIES_PATH: "./android/key.properties"

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64-v8a
            target: android-arm64
          - arch: armeabi-v7a
            target: android-arm
          - arch: x86_64
            target: android-x64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
      
      - run: |
          echo storeFile=\${{ secrets.KEY_STORE_PATH }} > ${{env.PROPERTIES_PATH}}
          echo password=\${{ secrets.KEY_PASSWORD }} >> ${{env.PROPERTIES_PATH}}
          echo keyAlias=\${{ secrets.KEY_ALIAS }} >> ${{env.PROPERTIES_PATH}}

      - run: echo "${{ secrets.KEYSTORE64 }}" | base64 --decode > android/${{ secrets.KEY_STORE_PATH }}

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK (${{ matrix.arch }})
        run: |
          flutter build apk --release --target-platform ${{ matrix.target }} --split-per-abi
          
      - name: Build Android Universal APK
        if: matrix.arch == 'x86_64'  # Only build universal APK once
        run: flutter build apk --release
          
      - name: Build Android App Bundle
        if: matrix.arch == 'x86_64'  # Only build AAB once
        run: flutter build appbundle --release

      - name: Upload Android APK (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ matrix.arch }}
          path: build/app/outputs/flutter-apk/app-${{ matrix.arch }}-release.apk

      - name: Upload Android Universal APK
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-universal
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Upload Android App Bundle
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Get dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd macos
          pod install

      - name: Build macOS (${{ matrix.arch }})
        run: |
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            flutter build macos --release --dart-define=FLUTTER_TARGET_PLATFORM=darwin-arm64
          else
            flutter build macos --release --dart-define=FLUTTER_TARGET_PLATFORM=darwin-x64
          fi

      - name: Create macOS DMG (${{ matrix.arch }})
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R "build/macos/Build/Products/Release/ROMs Downloader.app" dmg_contents/
          
          # Create DMG
          hdiutil create -volname "ROMs Downloader ${{ matrix.arch }}" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "ROMs_Downloader_macOS_${{ matrix.arch }}.dmg"

      - name: Upload macOS DMG (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-${{ matrix.arch }}
          path: "ROMs_Downloader_macOS_${{ matrix.arch }}.dmg"

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Get dependencies
        run: flutter pub get

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Build Windows (${{ matrix.arch }})
        run: |
          if ("${{ matrix.arch }}" -eq "arm64") {
            flutter build windows --release --dart-define=FLUTTER_TARGET_PLATFORM=windows-arm64
          } else {
            flutter build windows --release
          }

      - name: Create Windows installer (${{ matrix.arch }})
        run: |
          # Create a simple ZIP package with just the contents
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "ROMs_Downloader_Windows_${{ matrix.arch }}.zip"

      - name: Upload Windows package (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip-${{ matrix.arch }}
          path: "ROMs_Downloader_Windows_${{ matrix.arch }}.zip"

  build-linux-portmaster:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev zip

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux (${{ matrix.arch }})
        run: |
          flutter build linux --release

      - name: Package for PortMaster
        run: |
          chmod +x portmaster/package.sh
          cd portmaster
          ./package.sh
          mv roms_downloader.zip ../ROMs_Downloader_PortMaster_${{ matrix.arch }}.zip

      - name: Upload PortMaster package (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: portmaster-${{ matrix.arch }}
          path: "ROMs_Downloader_PortMaster_${{ matrix.arch }}.zip"

      - name: Create standard Linux AppImage (${{ matrix.arch }})
        run: |
          # Install FUSE for AppImage creation
          sudo apt-get install -y libfuse2
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications
          
          # Copy Flutter build
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # Copy icon if available
          if [ -f "assets/icon.png" ]; then
            cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/roms_downloader.png
            cp assets/icon.png AppDir/roms_downloader.png
          fi
          
          # Create desktop file in both locations (for compatibility)
          cat > AppDir/roms_downloader.desktop << 'EOF'
          [Desktop Entry]
          Name=ROMs Downloader
          Exec=roms_downloader
          Icon=roms_downloader
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          
          cat > AppDir/usr/share/applications/roms_downloader.desktop << 'EOF'
          [Desktop Entry]
          Name=ROMs Downloader
          Exec=roms_downloader
          Icon=roms_downloader
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          
          # Create AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${HERE}/usr/sbin/:${HERE}/usr/games/:${HERE}/bin/:${HERE}/sbin/${PATH:+:$PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${HERE}/usr/lib/i386-linux-gnu/:${HERE}/usr/lib/x86_64-linux-gnu/:${HERE}/usr/lib32/:${HERE}/usr/lib64/:${HERE}/lib/:${HERE}/lib/i386-linux-gnu/:${HERE}/lib/x86_64-linux-gnu/:${HERE}/lib32/:${HERE}/lib64/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share/${XDG_DATA_DIRS:+:$XDG_DATA_DIRS}"
          EXEC="${HERE}/usr/bin/roms_downloader"
          exec "${EXEC}" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Download appimagetool
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage
          
          # Set correct ARCH for AppImage
          if [ "${{ matrix.arch }}" = "x64" ]; then
            export ARCH=x86_64
          else
            export ARCH=aarch64
          fi
          
          # Create AppImage using extract-and-run method (works in CI)
          ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir ROMs_Downloader_Linux_${{ matrix.arch }}.AppImage

      - name: Upload Linux AppImage (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-${{ matrix.arch }}
          path: "ROMs_Downloader_Linux_${{ matrix.arch }}.AppImage"
  
  generate-download-links:
    needs: [build-android, build-macos, build-windows, build-linux-portmaster]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate download links summary
        run: |
          echo "# ðŸš€ ROMs Downloader - Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build completed successfully! Download links for all platforms and architectures:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“± Android" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | APK | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-----|------|" >> $GITHUB_STEP_SUMMARY
          
          for arch in arm64-v8a armeabi-v7a x86_64; do
            if [ -f "./artifacts/android-apk-${arch}/app-${arch}-release.apk" ]; then
              size=$(du -h "./artifacts/android-apk-${arch}/app-${arch}-release.apk" | cut -f1)
              echo "| ${arch} | [Download APK](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/android-apk-${arch}.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ -f "./artifacts/android-apk-universal/app-release.apk" ]; then
            size=$(du -h "./artifacts/android-apk-universal/app-release.apk" | cut -f1)
            echo "| Universal | [Download Universal APK](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/android-apk-universal.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "./artifacts/android-aab/app-release.aab" ]; then
            size=$(du -h "./artifacts/android-aab/app-release.aab" | cut -f1)
            echo "| App Bundle | [Download AAB](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/android-aab.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ–¥ï¸ macOS" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | DMG | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-----|------|" >> $GITHUB_STEP_SUMMARY
          
          for arch in x64 arm64; do
            if [ -f "./artifacts/macos-dmg-${arch}/ROMs_Downloader_macOS_${arch}.dmg" ]; then
              size=$(du -h "./artifacts/macos-dmg-${arch}/ROMs_Downloader_macOS_${arch}.dmg" | cut -f1)
              echo "| ${arch} | [Download DMG](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/macos-dmg-${arch}.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # Generate Linux download links
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ Linux & Embedded Devices" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for PortMaster packages
          echo "### ðŸŽ® PortMaster (Batocera, RockNix, JELOS)" >> $GITHUB_STEP_SUMMARY
          echo "**Drop in /roms/ports folder - no other setup needed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | PortMaster Package | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------------------|------|" >> $GITHUB_STEP_SUMMARY
          
          for arch in x64 arm64; do
            if [ -f "./artifacts/portmaster-${arch}/ROMs_Downloader_PortMaster_${arch}.zip" ]; then
              pm_size=$(du -h "./artifacts/portmaster-${arch}/ROMs_Downloader_PortMaster_${arch}.zip" | cut -f1)
              echo "| ${arch} | [Download for PortMaster](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/portmaster-${arch}.zip) | ${pm_size} |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸªŸ Windows" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | ZIP Package | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------------|------|" >> $GITHUB_STEP_SUMMARY
          
          for arch in x64 arm64; do
            if [ -f "./artifacts/windows-zip-${arch}/ROMs_Downloader_Windows_${arch}.zip" ]; then
              size=$(du -h "./artifacts/windows-zip-${arch}/ROMs_Downloader_Windows_${arch}.zip" | cut -f1)
              echo "| ${arch} | [Download ZIP](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/windows-zip-${arch}.zip) | ${size} |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Build Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
