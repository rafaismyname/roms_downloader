name: Build Linux ARM64 (PortMaster/flutter-pi)

on:
  push:
    branches: [ "arm64" ]
  workflow_dispatch:

jobs:
  build-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: uraimo/run-on-arch-action@v2
        name: Build Artifact
        id: build
        with:
          arch: aarch64
          distro: ubuntu20.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            # Install dependencies for Flutter and flutter-pi compilation
            # Split installation to avoid dpkg errors with python3
            apt-get install -y curl git unzip xz-utils zip build-essential cmake pkg-config
            apt-get install -y libc6-dev
            apt-get install -y libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev
            apt-get install -y libdrm-dev libgbm-dev fontconfig
            apt-get install -y libsystemd-dev libinput-dev libudev-dev libxkbcommon-dev
            apt-get install -y libgtk-3-dev
            # Install build tools for Flutter (clang, ninja)
            apt-get install -y ninja-build clang
          run: |
            # 1. Install Flutter
            git clone https://github.com/flutter/flutter.git -b stable --depth 1
            export PATH="$PATH:$PWD/flutter/bin"
            git config --global --add safe.directory '*'
            
            # 2. Configure Flutter
            flutter config --enable-linux-desktop
            
            # 3. Build flutter-pi (The Embedder)
            echo "Building flutter-pi..."
            git clone https://github.com/ardera/flutter-pi.git
            cd flutter-pi
            mkdir build && cd build
            cmake .. || (cat CMakeFiles/CMakeError.log && exit 1)
            # Reduce parallelism to avoid OOM/Segfault in QEMU
            make -j1
            # Save the binary for later
            cp flutter-pi ../../flutter-pi-bin
            cd ../../
            
            # 4. Build the Flutter App (Assets + Engine)
            echo "Building Flutter App..."
            flutter pub get
            # Build standard Linux release (produces ARM64 AOT since we are on ARM64)
            flutter build linux --release
            
            # 5. Package for PortMaster
            echo "Packaging..."
            mkdir -p dist/ports/roms_downloader/flutter_assets
            
            # Copy the flutter-pi binary
            cp flutter-pi-bin dist/ports/roms_downloader/flutter-pi
            
            # Copy the build output
            # Source: build/linux/arm64/release/bundle/
            
            # 1. Assets
            cp -r build/linux/arm64/release/bundle/data/flutter_assets/* dist/ports/roms_downloader/flutter_assets/
            
            # 2. AOT Blob (app.so) - Must be inside flutter_assets for flutter-pi
            cp build/linux/arm64/release/bundle/lib/libapp.so dist/ports/roms_downloader/flutter_assets/
            
            # 3. Engine
            # Robust search for the engine
            ENGINE_PATH=$(find build/linux/arm64/release/bundle -name "libflutter_engine.so" | head -n 1)
            if [ -z "$ENGINE_PATH" ]; then
              echo "ERROR: libflutter_engine.so not found! Dumping build directory:"
              ls -R build/linux/arm64/release/bundle
              exit 1
            fi
            echo "Found engine at: $ENGINE_PATH"
            cp "$ENGINE_PATH" dist/ports/roms_downloader/
            
            # 4. ICU Data (if present)
            if [ -f build/linux/arm64/release/bundle/data/icudtl.dat ]; then
              cp build/linux/arm64/release/bundle/data/icudtl.dat dist/ports/roms_downloader/
            else
              find build/linux/arm64/release/bundle -name "icudtl.dat" -exec cp {} dist/ports/roms_downloader/ \;
            fi
            
            # Copy launch script
            cp assets/scripts/roms_downloader.sh dist/ports/roms_downloader.sh
            chmod +x dist/ports/roms_downloader.sh
            chmod +x dist/ports/roms_downloader/flutter-pi
            
            # Create ZIP
            cd dist
            zip -r ../roms_downloader_portmaster.zip ports/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: roms_downloader_portmaster
          path: roms_downloader_portmaster.zip
