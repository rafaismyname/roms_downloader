name: Build Linux ARM64 (PortMaster/flutter-pi)

on:
  push:
    branches: [ "arm64" ]
  workflow_dispatch:

jobs:
  build-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - uses: uraimo/run-on-arch-action@v2
        name: Build Artifact
        id: build
        with:
          arch: aarch64
          distro: ubuntu20.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            # Install dependencies for Flutter and flutter-pi compilation
            # Split installation to avoid dpkg errors with python3
            apt-get install -y curl git unzip xz-utils zip build-essential cmake pkg-config
            apt-get install -y libc6-dev
            apt-get install -y libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev
            apt-get install -y libdrm-dev libgbm-dev fontconfig
            apt-get install -y libsystemd-dev libinput-dev libudev-dev libxkbcommon-dev
            apt-get install -y libgtk-3-dev
            # Install build tools for Flutter (clang, ninja)
            apt-get install -y ninja-build clang
          run: |
            # 1. Install Flutter (Pinned to 3.35.4 for compatible Release Engine)
            git clone https://github.com/flutter/flutter.git -b 3.35.4 --depth 1
            export PATH="$PATH:$PWD/flutter/bin"
            git config --global --add safe.directory '*'
            
            # 2. Configure Flutter
            flutter config --enable-linux-desktop
            
            # 3. Build flutter-pi (The Embedder)
            echo "Building flutter-pi with minimal dependencies..."
            chmod +x linux/compile_flutter_pi.sh
            ./linux/compile_flutter_pi.sh
            
            # Save the binary for later
            # The script builds in build_flutter/flutter-pi/build/flutter-pi
            cp build_flutter/flutter-pi/build/flutter-pi flutter-pi-bin
            
            # 4. Build the Flutter App (Assets + Engine)
            echo "Building Flutter App..."
            flutter pub get
            # Build standard Linux release (produces ARM64 AOT since we are on ARM64)
            flutter build linux --release
            
            # 5. Package for PortMaster
            echo "Packaging..."
            mkdir -p dist/ports/roms_downloader/flutter_assets
            
            # Copy the flutter-pi binary
            cp flutter-pi-bin dist/ports/roms_downloader/flutter-pi
            
            # Copy the build output
            # Source: build/linux/arm64/release/bundle/
            
            # 1. Assets
            cp -r build/linux/arm64/release/bundle/data/flutter_assets/* dist/ports/roms_downloader/flutter_assets/
            
            # 2. AOT Blob (app.so) - Must be inside flutter_assets for flutter-pi
            # flutter-pi typically expects 'app.so' for AOT snapshots
            cp build/linux/arm64/release/bundle/lib/libapp.so dist/ports/roms_downloader/flutter_assets/app.so
            
            # Bundle shared libraries that might be missing on target
            # We place them in a 'bundled_libs' folder so the launch script can selectively use them
            echo "Bundling shared libraries..."
            mkdir -p dist/ports/roms_downloader/bundled_libs
            
            # Comprehensive list of potential missing libs on minimal distros (Knulli, Batocera, etc.)
            # Based on Ubuntu 20.04 dependency tree
            LIBS_TO_BUNDLE="libdrm.so.2 libgbm.so.1 libexpat.so.1 \
                            libinput.so.10 libevdev.so.2 libmtdev.so.1 \
                            libwacom.so.2 libgudev-1.0.so.0 libudev.so.1 \
                            libgobject-2.0.so.0 libglib-2.0.so.0 libffi.so.7 libpcre.so.3 \
                            libxkbcommon.so.0 \
                            libwayland-server.so.0 libwayland-client.so.0 libwayland-cursor.so.0 libwayland-egl.so.1 \
                            libsystemd.so.0 \
                            libcap.so.2 libgcrypt.so.20 libgpg-error.so.0 \
                            liblz4.so.1 liblzma.so.5 libzstd.so.1 \
                            libmount.so.1 libblkid.so.1 libuuid.so.1 libselinux.so.1 libpcre2-8.so.0 \
                            libfontconfig.so.1 libfreetype.so.6 libssl.so.1.1 libcrypto.so.1.1"
            
            for LIB in $LIBS_TO_BUNDLE; do
                # Search in common library paths
                PATH_TO_LIB=$(find /usr/lib/aarch64-linux-gnu /lib/aarch64-linux-gnu /usr/lib /lib -name "$LIB" 2>/dev/null | head -n 1)
                if [ -n "$PATH_TO_LIB" ]; then
                    echo "Bundling $LIB from $PATH_TO_LIB"
                    cp "$PATH_TO_LIB" dist/ports/roms_downloader/bundled_libs/
                else
                    echo "WARNING: $LIB not found in build environment!"
                fi
            done
            
            # 3. Engine - MANUAL DOWNLOAD (Community Release Binary)
            # The official Google artifact is Debug-only. We use Ardera's repo for Release binaries.
            echo "Downloading correct Release engine for ARM64..."
            
            # Download ZIP
            curl -L -o engine.zip https://github.com/ardera/flutter-engine-binaries-for-arm/archive/refs/tags/engine_c29809135135e262a912cf583b2c90deb9ded610.zip
            unzip engine.zip
            mv flutter-engine-binaries-for-arm-* engine-binaries
            rm engine.zip
            
            ENGINE_PATH="engine-binaries/arm64/libflutter_engine.so.release"
            if [ ! -f "$ENGINE_PATH" ]; then
               echo "ERROR: libflutter_engine.so.release not found in community repo!"
               ls -R engine-binaries
               exit 1
            fi
            
            echo "Found engine at: $ENGINE_PATH"
            # Copy and rename to libflutter_engine.so (remove .release suffix)
            cp "$ENGINE_PATH" dist/ports/roms_downloader/libflutter_engine.so
            
            # Clean up engine repo
            rm -rf engine-binaries
            
            # 4. ICU Data
            # flutter-pi expects icudtl.dat inside the flutter_assets directory
            ICU_DATA_PATH=$(find build/linux/arm64/release/bundle -name "icudtl.dat" | head -n 1)
            if [ -z "$ICU_DATA_PATH" ]; then
               echo "ICU Data not found in bundle. Searching in Flutter cache..."
               ICU_DATA_PATH=$(find flutter/bin/cache/artifacts/engine -name "icudtl.dat" | head -n 1)
            fi
            
            if [ -z "$ICU_DATA_PATH" ]; then
               echo "ERROR: icudtl.dat not found!"
               exit 1
            fi
            
            echo "Found ICU data at: $ICU_DATA_PATH"
            cp "$ICU_DATA_PATH" dist/ports/roms_downloader/flutter_assets/
            
            # Copy launch script
            cp linux/roms_downloader.sh dist/ports/roms_downloader.sh
            chmod +x dist/ports/roms_downloader.sh
            chmod +x dist/ports/roms_downloader/flutter-pi
            
            # Create ZIP
            cd dist
            zip -r ../roms_downloader_portmaster.zip ports/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: roms_downloader_portmaster
          path: roms_downloader_portmaster.zip
